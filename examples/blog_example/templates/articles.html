<html lang="en">
<head>
    <title>Articles</title>
</head>
<body>
<a href="/blog/feed">Home</a>
{{if ne $.user ""}}
Welcome "{{$.user}}"!
<a href="/logout">Logout</a>
<h1>New post?</h1>
<form method="post" action="/blog/post">
    {{.CSRFToken}}
    <label>
        <input type="text" name="title" placeholder="Title">
    </label><br>
    <label>
        <textarea name="content" rows="4" cols="50" placeholder="Write your article here..."></textarea>
    </label><br>
    <button type="submit">Submit</button>
</form>
{{end}}
{{if eq $.user ""}}
<p>Please log in to create a new post.</p>
<a href="/auth/openid-connect">Login with OpenId</a><br>
<a href="/auth/google">Login with Google</a>
{{end}}
<h1>Articles</h1>
<ul>
    {{range .feed}}
    <li id="post-{{.Id}}">
        <div class="post-view">
            <h2 class="post-title">{{.Title}}</h2>
            <p class="post-content">{{.Content}}</p>
            <small>Published on: {{.PublicationDate}} by {{.Owner}}</small>
            {{if eq $.user .Owner}}
            <button class="edit-btn" data-postid="{{.Id}}">Edit</button>
            <button class="delete-btn" data-postid="{{.Id}}">Delete</button>
            {{end}}
        </div>
        <form class="edit-form" style="display:none;" method="post" action="/blog/post">
            <input type="hidden" name="id" value="{{.Id}}">
            <label>
                <input type="text" name="title" value="{{.Title}}">
            </label><br>
            <label>
                <textarea name="content" rows="4" cols="50">{{.Content}}</textarea>
            </label><br>
            <button type="submit">Save</button>
            <button type="button" class="cancel-btn">Cancel</button>
        </form>
    </li>
    {{end}}
</ul>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var postId = btn.getAttribute('data-postid');
            var li = document.getElementById('post-' + postId);
            li.querySelector('.post-view').style.display = 'none';
            li.querySelector('.edit-form').style.display = 'block';
        });
    });
    document.querySelectorAll('.cancel-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var li = btn.closest('li');
            li.querySelector('.edit-form').style.display = 'none';
            li.querySelector('.post-view').style.display = 'block';
        });
    });
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to delete this post?')) return;
            var postId = btn.getAttribute('data-postid');
            fetch('/blog/post/' + postId, {
                method: 'DELETE',
                credentials: 'same-origin'
            }).then(function(response) {
                if (response.ok) {
                    window.location.href = '/blog/feed';
                } else {
                    alert('Failed to delete post.');
                }
            }).catch(function() {
                alert('Failed to delete post.');
            });
        });
    });
});
</script>
</body>
</html>